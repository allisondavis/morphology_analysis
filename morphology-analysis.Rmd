---
title: "morphology_analysis"
author: "Allison Davis"
date: "November 21, 2019"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Data collection



```{r}
library(curl)

raw <- curl("https://raw.githubusercontent.com/allisondavis/morphology_analysis/master/adavis_morph-raw_all.csv")

raw <- read.csv(raw, header = TRUE, sep = ",", stringsAsFactors = TRUE)

head(raw)

form <- curl("https://raw.githubusercontent.com/allisondavis/morphology_analysis/master/adavis_morph-raw_formosa.csv")

form <- read.csv(form, header = TRUE, sep = ",", stringsAsFactors = TRUE)
form <- cbind(form, spp="form")
head(form)

lat <- curl("https://raw.githubusercontent.com/allisondavis/morphology_analysis/master/adavis_morph-raw_latipinna.csv")

lat <- read.csv(lat, header = TRUE, sep = ",", stringsAsFactors = TRUE)

head(lat)
lat <- cbind(lat, spp="lat")

```

#### <font color="deepskyblue">Correction for Body Size</font>

Certain size characteristics are influenced by overall body length, and therefore need to be corrected based on the individual's length prior to comparisons. 

Additionally, size characteristics and characteristics such as ray count are in differing units. To compare variation between *all* characteristics, I will get z scores for all characteristics.

```{r echo=FALSE}

latRM <- lat[,-c(10)]

latRM
normFunc <- function(x){(x-mean(x, na.rm = T))/sd(x, na.rm = T)}

z_lat <- apply(latRM[8:27], 2, normFunc)

latRM <- cbind(latRM, z_lat)
colnames(latRM)[29:48] <- c("ZD", "ZP1", "ZA", "ZP1.R", "ZLLSC", "ZSALL", "ZSBLL", "ZSBDF", "ZTL", "ZSL", "ZBD", "ZCPD", "ZCPL", "ZPreDL", "ZDbL", "ZHL", "ZHD", "ZHW", "ZSnL", "ZOL")
latRM


formRM <- form[,-c(10)]

z_form <- apply(formRM[8:27], 2, normFunc)

formRM <- cbind(formRM, z_form)
colnames(formRM)[29:48] <- c("ZD", "ZP1", "ZA", "ZP1.R", "ZLLSC", "ZSALL", "ZSBLL", "ZSBDF", "ZTL", "ZSL", "ZBD", "ZCPD", "ZCPL", "ZPreDL", "ZDbL", "ZHL", "ZHD", "ZHW", "ZSnL", "ZOL")
formRM

```



#### BOX PLOTS

```{r echo=FALSE}

library(ggplot2)

ggplot(raw, aes(x=SPP, y=D, fill=SPP)) + geom_boxplot() + xlab("Species") + ylab("Ray count\n") + ggtitle("Dorsal ray comparison\n") + geom_jitter(shape=16, position=position_jitter(0.2)) + theme_classic() + scale_fill_manual(values = c("#9C964A", "#FAD77B")) + theme(text = element_text(size = 16)) + theme(legend.position = "none")


ggplot(raw, aes(x=SPP, y=P1, fill=SPP)) + geom_boxplot() + xlab("Species") + ylab("Ray count\n") + ggtitle("Left pectoral ray comparison\n") + geom_jitter(shape=16, position=position_jitter(0.2)) + theme_classic() + scale_fill_manual(values = c("#9C964A", "#FAD77B")) + theme(text = element_text(size = 16)) + theme(legend.position = "none")


ggplot(raw, aes(x=SPP, y=P2)) + geom_boxplot() + xlab("Species") + ylab("Ray count") + ggtitle("Pelvic ray comparison") + geom_jitter(shape=16, position=position_jitter(0.2)) #need to do an average or separate out pelvic right and pelvic left

ggplot(raw, aes(x=SPP, y=A)) + geom_boxplot() + xlab("Species") + ylab("Ray count") + ggtitle("Anal ray comparison") + geom_jitter(shape=16, position=position_jitter(0.2))

ggplot(raw, aes(x=SPP, y=P1.R)) + geom_boxplot() + xlab("Species") + ylab("Ray count") + ggtitle("Right pectorcal ray comparison") + geom_jitter(shape=16, position=position_jitter(0.2))

ggplot(raw, aes(x=SPP, y=LLSC)) + geom_boxplot() + xlab("Species") + ylab("Scale count") + ggtitle("Lateral line scale comparison") + geom_jitter(shape=16, position=position_jitter(0.2))

ggplot(raw, aes(x=SPP, y=SALL)) + geom_boxplot() + xlab("Species") + ylab("Scale count") + ggtitle("Scales above Lateral line comparison") + geom_jitter(shape=16, position=position_jitter(0.2))

ggplot(raw, aes(x=SPP, y=SBLL)) + geom_boxplot() + xlab("Species") + ylab("Scale count") + ggtitle("Scales below Lateral line comparison") + geom_jitter(shape=16, position=position_jitter(0.2))

ggplot(raw, aes(x=SPP, y=SBDF)) + geom_boxplot() + xlab("Species") + ylab("Scale count") + ggtitle("Scales before dorsal fin comparison") + geom_jitter(shape=16, position=position_jitter(0.2))

ggplot(raw, aes(x=SPP, y=TL)) + geom_boxplot() + xlab("Species") + ylab("Size (mm)") + ggtitle("Total length comparison") + geom_jitter(shape=16, position=position_jitter(0.2))

ggplot(raw, aes(x=SPP, y=SL)) + geom_boxplot() + xlab("Species") + ylab("Size (mm)") + ggtitle("Standard length comparison") + geom_jitter(shape=16, position=position_jitter(0.2))

ggplot(raw, aes(x=SPP, y=BD)) + geom_boxplot() + xlab("Species") + ylab("Size (mm)") + ggtitle("Body depth comparison") + geom_jitter(shape=16, position=position_jitter(0.2))

ggplot(raw, aes(x=SPP, y=CPD)) + geom_boxplot() + xlab("Species") + ylab("Size (mm)") + ggtitle("Caudal peduncle comparison") + geom_jitter(shape=16, position=position_jitter(0.2))

ggplot(raw, aes(x=SPP, y=CPL)) + geom_boxplot() + xlab("Species") + ylab("Size (mm)") + ggtitle("Caudal peduncle length comparison") + geom_jitter(shape=16, position=position_jitter(0.2))

ggplot(raw, aes(x=SPP, y=PreDL)) + geom_boxplot() + xlab("Species") + ylab("Size (mm)") + ggtitle("Pre-dorsal length comparison") + geom_jitter(shape=16, position=position_jitter(0.2))

ggplot(raw, aes(x=SPP, y=DbL)) + geom_boxplot() + xlab("Species") + ylab("Size (mm)") + ggtitle("Dorsal base length comparison") + geom_jitter(shape=16, position=position_jitter(0.2))

ggplot(raw, aes(x=SPP, y=HL)) + geom_boxplot() + xlab("Species") + ylab("Size (mm)") + ggtitle("Head length comparison") + geom_jitter(shape=16, position=position_jitter(0.2))

ggplot(raw, aes(x=SPP, y=HD)) + geom_boxplot() + xlab("Species") + ylab("Size (mm)") + ggtitle("Head depth comparison") + geom_jitter(shape=16, position=position_jitter(0.2))

ggplot(raw, aes(x=SPP, y=HW)) + geom_boxplot() + xlab("Species") + ylab("Size (mm)") + ggtitle("Head width comparison") + geom_jitter(shape=16, position=position_jitter(0.2))

ggplot(raw, aes(x=SPP, y=SnL)) + geom_boxplot() + xlab("Species") + ylab("Size (mm)") + ggtitle("Snout length comparison") + geom_jitter(shape=16, position=position_jitter(0.2))

ggplot(raw, aes(x=SPP, y=OL)) + geom_boxplot() + xlab("Species") + ylab("Size (mm)") + ggtitle("Orbital length comparison") + geom_jitter(shape=16, position=position_jitter(0.2))



```



#### T.TESTS

```{r}
#doral ray counts
t.test(lat$D, form$D, alternative = "two.sided")

#left pectoral ray counts
t.test(lat$P1, form$P1, alternative = "two.sided")

#won't do pelvic, since it's currently in weird format

#anal ray counts
t.test(lat$A, form$A, alternative = "two.sided")

#right pectoral ray counts
t.test(lat$P1.R, form$P1.R, alternative = "two.sided")

#lateral line scale count
t.test(lat$LLSC, form$LLSC, alternative = "two.sided")

#scales above lateral line
t.test(lat$SALL, form$SALL, alternative = "two.sided")

#scales below lateral line
t.test(lat$SBLL, form$SBLL, alternative = "two.sided")

#scales before dorsal fin
t.test(lat$SBDF, form$SBDF, alternative = "two.sided")

#total length
t.test(lat$TL, form$TL, alternative = "two.sided")

#standard length
t.test(lat$SL, form$SL, alternative = "two.sided")

#body depth
t.test(lat$BD, form$BD, alternative = "two.sided")

#caudal peduncle depth
t.test(lat$CPD, form$CPD, alternative = "two.sided")

#caudal peduncle length
t.test(lat$CPL, form$CPL, alternative = "two.sided")

#pre dorsal length
t.test(lat$PreDL, form$PreDL, alternative = "two.sided")

#dorsal base length
t.test(lat$DbL, form$DbL, alternative = "two.sided")

#head length
t.test(lat$HL, form$HL, alternative = "two.sided")

#head depth
t.test(lat$HD, form$HD, alternative = "two.sided")

#head width
t.test(lat$HW, form$HW, alternative = "two.sided")

#snout length
t.test(lat$SnL, form$SnL, alternative = "two.sided")

#oribital length
t.test(lat$OL, form$OL, alternative = "two.sided")

```


#### TYPE III ANOVA - CORRECTING FOR SL

```{r}
library(car)

raw2 <- rbind(latRM, formRM)
raw2

#lateral line scale count
Anova(lm(data = raw, LLSC ~ SPP * SL), type = "III")

#scales above lateral line
Anova(lm(data = raw, SALL ~ SPP * SL), type = "III")

#scales below lateral line
Anova(lm(data = raw, SBLL ~ SPP * SL), type = "III")

#scales before dorsal fin
Anova(lm(data = raw, SBDF ~ SPP * SL), type = "III")

#total length
Anova(lm(data = raw2, ZTL ~ spp * SL), type = "III")

#body depth
Anova(lm(data = raw, BD ~ SPP * SL), type = "III")

#caudal peduncle depth
Anova(lm(data = raw, CPD ~ SPP * SL), type = "III")

#caudal peduncle length
Anova(lm(data = raw, CPL ~ SPP * SL), type = "III")

#pre dorsal length
Anova(lm(data = raw, PreDL ~ SPP * SL), type = "III")

#dorsal base length
Anova(lm(data = raw, DbL ~ SPP * SL), type = "III")

#head length
Anova(lm(data = raw, HL ~ SPP * SL), type = "III")

#head depth
Anova(lm(data = raw, HD ~ SPP * SL), type = "III")

#head width
Anova(lm(data = raw, HW ~ SPP * SL), type = "III")

#snout length
Anova(lm(data = raw, SnL ~ SPP * SL), type = "III")

#oribital length
Anova(lm(data = raw, OL ~ SPP * SL), type = "III")



```




#### VARIANCE TESTS

```{r}
#doral ray counts
var.test(lat$D, form$D, alternative = "two.sided")

#left pectoral ray counts
var.test(lat$P1, form$P1, alternative = "two.sided")

#won't do pelvic, since it's currently in weird format

#anal ray counts
var.test(lat$A, form$A, alternative = "two.sided")

#right pectoral ray counts
var.test(lat$P1.R, form$P1.R, alternative = "two.sided")

#lateral line scale count
var.test(lat$LLSC, form$LLSC, alternative = "two.sided")

#scales above lateral line
var.test(lat$SALL, form$SALL, alternative = "two.sided")

#scales below lateral line
var.test(lat$SBLL, form$SBLL, alternative = "two.sided")

#scales before dorsal fin
var.test(lat$SBDF, form$SBDF, alternative = "two.sided")

#total length
var.test(lat$TL, form$TL, alternative = "two.sided")

#standard length
var.test(lat$SL, form$SL, alternative = "two.sided")

#body depth
var.test(lat$BD, form$BD, alternative = "two.sided")

#caudal peduncle depth
var.test(lat$CPD, form$CPD, alternative = "two.sided")

#caudal peduncle length
var.test(lat$CPL, form$CPL, alternative = "two.sided")

#pre dorsal length
var.test(lat$PreDL, form$PreDL, alternative = "two.sided")

#dorsal base length
var.test(lat$DbL, form$DbL, alternative = "two.sided")

#head length
var.test(lat$HL, form$HL, alternative = "two.sided")

#head depth
var.test(lat$HD, form$HD, alternative = "two.sided")

#head width
var.test(lat$HW, form$HW, alternative = "two.sided")

#snout length
var.test(lat$SnL, form$SnL, alternative = "two.sided")

#oribital length
var.test(lat$OL, form$OL, alternative = "two.sided")

```


### **Testing this correction for size biz**

* STEP ONE: plot trait vs body size

```{r}
reg.lat.LLSC <- lm(lat$LLSC ~ lat$SL)
reg.lat.LLSC

reg.for.LLSC <- lm(form$LLSC ~ form$SL)
reg.for.LLSC

```

* STEP TWO: get residuals for each individual for that trait

```{r}
res.lat.LLSC <- resid(reg.lat.LLSC)
res.lat.LLSC

res.for.LLSC <- resid(reg.for.LLSC)
res.for.LLSC

```


* STEP THREE: convert residuals to absolute value ***MIKE SAID TO RUN FIRST W/RES AND THEN W/ABS AND NOTE WHEN THE SIG LEVELS ARE DIFFERENT***

```{r}
abs.lat.LLSC <- abs(res.lat.LLSC)
abs.lat.LLSC

abs.for.LLSC <- abs(res.for.LLSC)
abs.for.LLSC

```

* STEP 4a: perform F tests to compare species

```{r}
var.res.LLSC <- var.test(abs.lat.LLSC, abs.for.LLSC, alternative = "greater")
var.res.LLSC

check <- var.test(res.lat.LLSC, abs.for.LLSC, alternative = "greater")
check

```



library(car)
m <- lm(data = raw, formula = LLSC ~ SL * SPP)
summary(m)
a <- lm(data=raw, LLSC~ SPP * SL)
a <- Anova(a, type="III")
a


options(contrasts = c("contr.sum", "contr.poly"))

z <- Anova(lm(data = raw, D~SPP*SL, contrasts = list(topic="contr.sum", sys="contr.sum")), type="III")

summary(z)

hist(residuals(m))
qqnorm(residuals(m))
 qqline(residuals(m))
 
library(nlme)

model1 <- gls(D~SPP, data = raw)
summary(model1)

model2<- update(model1, weights= varIdent(form = ~1 | SPP))
summary(model2)
 
 
 





